<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSV Viewer</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 16px;
      color: #111;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .dropzone {
      border: 2px dashed #bbb;
      border-radius: 6px;
      padding: 12px;
      color: #666;
    }
    .dropzone.dragover {
      border-color: #4a90e2;
      background: #f4f9ff;
      color: #2c5ea8;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 1;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    tbody td {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    tbody tr:nth-child(even) td {
      background: #fcfcfc;
    }
    .hint {
      color: #666;
      font-size: 12px;
    }
    .status {
      color: #444;
      font-size: 12px;
      margin-left: auto;
    }
    .sr {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }
  </style>
</head>
<body>
  <h1>TSV Viewer</h1>
  <div class="controls">
    <label>
      <span class="hint">Choose TSV</span>
      <input id="fileInput" type="file" accept=".tsv,.txt,.csv,text/tab-separated-values" />
    </label>
    <div id="dropzone" class="dropzone" title="Drag and drop a TSV file here">Drop TSV file here</div>
    <div class="status" id="status"></div>
  </div>

  <table id="table" aria-live="polite">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const fileInput = document.getElementById("fileInput");
    const dropzone = document.getElementById("dropzone");
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    const statusEl = document.getElementById("status");

    let data = [];      // array of objects, keys are headers
    let headers = [];   // header names in order
    let sortState = { col: null, dir: 1 }; // 1 asc, -1 desc

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function parseTSV(text) {
      const rows = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
      const nonEmpty = rows.filter(r => r.trim().length > 0);
      if (nonEmpty.length === 0) return { headers: [], rows: [] };
      const head = nonEmpty[0].split("\t");
      const outRows = [];
      for (let i = 1; i < nonEmpty.length; i++) {
        const cols = nonEmpty[i].split("\t");
        // pad shorter rows
        while (cols.length < head.length) cols.push("");
        outRows.push(cols);
      }
      return { headers: head, rows: outRows };
    }

    function detectNumeric(value) {
      if (value == null) return false;
      const s = String(value).trim();
      if (s === "") return false;
      // remove common adornments: % , $ spaces
      const norm = s.replace(/[%,$]/g, "");
      return !isNaN(norm) && isFinite(Number(norm));
    }

    function numericValue(value) {
      if (value == null) return NaN;
      const s = String(value).trim().replace(/[%,$]/g, "");
      const n = Number(s);
      return isFinite(n) ? n : NaN;
    }

    function buildData(parsed) {
      headers = parsed.headers;
      data = parsed.rows.map(cols => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = cols[i]);
        return obj;
      });
    }

    function clearTable() {
      thead.innerHTML = "";
      tbody.innerHTML = "";
    }

    function renderTable() {
      clearTable();
      if (!headers.length) return;

      const trHead = document.createElement("tr");
      headers.forEach((h, idx) => {
        const th = document.createElement("th");
        th.textContent = h;
        th.title = "Click to sort";
        th.addEventListener("click", () => sortBy(idx));
        if (sortState.col === idx) {
          const arrow = sortState.dir === 1 ? " ▲" : " ▼";
          th.textContent = h + arrow;
        }
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      const frag = document.createDocumentFragment();
      for (const row of data) {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h] ?? "";
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
      setStatus(`Rows: ${data.length} | Columns: ${headers.length}`);
    }

    function sortBy(colIdx) {
      if (sortState.col === colIdx) {
        sortState.dir = -sortState.dir;
      } else {
        sortState.col = colIdx;
        sortState.dir = 1;
      }
      const key = headers[colIdx];
      const isNum = data.some(r => detectNumeric(r[key]));
      data.sort((a, b) => {
        const A = a[key];
        const B = b[key];
        if (isNum) {
          const nA = numericValue(A);
          const nB = numericValue(B);
          if (isNaN(nA) && isNaN(nB)) return 0;
          if (isNaN(nA)) return 1; // NaNs last
          if (isNaN(nB)) return -1;
          return sortState.dir * (nA - nB);
        } else {
          const sA = String(A ?? "").toLowerCase();
          const sB = String(B ?? "").toLowerCase();
          if (sA < sB) return -1 * sortState.dir;
          if (sA > sB) return 1 * sortState.dir;
          return 0;
        }
      });
      renderTable();
    }

    function loadFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = parseTSV(reader.result);
          buildData(parsed);
          // Default sort: none
          sortState = { col: null, dir: 1 };
          renderTable();
        } catch (e) {
          console.error(e);
          alert("Failed to parse TSV file.");
        }
      };
      reader.readAsText(file);
    }

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      loadFile(file);
    });

    ;["dragenter", "dragover"].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add("dragover");
      })
    );
    ;["dragleave", "drop"].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove("dragover");
      })
    );
    dropzone.addEventListener("drop", (e) => {
      const files = e.dataTransfer.files;
      if (files && files.length) {
        loadFile(files[0]);
      }
    });
  </script>
</body>
</html>


